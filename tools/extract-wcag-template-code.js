/*
  Extracts WCAG template markup from the template host component and generates
  a TypeScript mapping file for display as "real code".

  Usage:
    node tools/extract-wcag-template-code.js
*/

'use strict';

const fs = require('fs');
const path = require('path');

const workspaceRoot = path.resolve(__dirname, '..');
const templatesPath = path.join(
  workspaceRoot,
  'src',
  'app',
  'components',
  'wcag-demo',
  'wcag-case-templates.component.html'
);

const outPath = path.join(
  workspaceRoot,
  'src',
  'app',
  'components',
  'wcag-demo',
  'wcag-case-code.data.ts'
);

function normalizeIndent(multiline) {
  const lines = multiline.replace(/\r\n/g, '\n').split('\n');

  // Trim leading/trailing empty lines.
  while (lines.length && lines[0].trim() === '') lines.shift();
  while (lines.length && lines[lines.length - 1].trim() === '') lines.pop();

  // Compute minimal indentation across non-empty lines.
  let minIndent = null;
  for (const line of lines) {
    if (line.trim() === '') continue;
    const match = line.match(/^[\t ]*/);
    const indentLen = match ? match[0].length : 0;
    if (minIndent === null || indentLen < minIndent) minIndent = indentLen;
  }

  if (!minIndent) return lines.join('\n');
  return lines.map((l) => (l.length >= minIndent ? l.slice(minIndent) : l)).join('\n');
}

function extractTemplates(html) {
  const templates = [];
  const re = /<ng-template\b[^>]*\bwcagCaseTemplate="([^"]+)"[^>]*>([\s\S]*?)<\/ng-template>/g;
  let match;

  while ((match = re.exec(html)) !== null) {
    const key = match[1];
    const inner = normalizeIndent(match[2]);
    templates.push({ key, code: inner });
  }

  return templates;
}

function toTsMapping(templates) {
  // Stable order for diff friendliness.
  templates.sort((a, b) => a.key.localeCompare(b.key));

  const lines = [];
  lines.push('/*');
  lines.push('  AUTO-GENERATED FILE â€” DO NOT EDIT BY HAND');
  lines.push('  Generated by: tools/extract-wcag-template-code.js');
  lines.push('*/');
  lines.push('');
  lines.push('export const WCAG_TEMPLATE_CODE: { [key: string]: string } = {');

  for (const { key, code } of templates) {
    lines.push(`  ${JSON.stringify(key)}: ${JSON.stringify(code)},`);
  }

  lines.push('};');
  lines.push('');
  return lines.join('\n');
}

function main() {
  if (!fs.existsSync(templatesPath)) {
    console.error('Template file not found:', templatesPath);
    process.exit(1);
  }

  const html = fs.readFileSync(templatesPath, 'utf8');
  const templates = extractTemplates(html);

  if (!templates.length) {
    console.error('No templates found. Expected ng-template with wcagCaseTemplate="...".');
    process.exit(2);
  }

  const ts = toTsMapping(templates);
  fs.writeFileSync(outPath, ts, 'utf8');

  console.log(`Generated ${path.relative(workspaceRoot, outPath)} with ${templates.length} entries.`);
}

main();
